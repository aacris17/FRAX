---
title: "Code for descriptive characteristics"
author: "Anthony Criscitiello"
date: "3/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(readr)
library(lubridate)
library(tibble)
library(purrr)
library(stringr)
```
```{r 0}
DM_Dates_fx <- read_csv("C:/Users/acriscit/Documents/Results/DM_Dates_fx.csv")
Fracture_Dates_fx <- read_csv("C:/Users/acriscit/Documents/Results/Fracture_Dates_fx.csv")
Visit_Dates_fx <- read_csv("C:/Users/acriscit/Documents/Results/Visit_Dates_fx.csv")

#Load control data
DM_Dates_ed <- read_csv("C:/Users/acriscit/Documents/Results/DM_Dates_ed.csv")
EM_Dates_ed <- read_csv("C:/Users/acriscit/Documents/Results/EM_Dates_ed.csv")
Visit_Dates_ed <- read_csv("C:/Users/acriscit/Documents/Results/Visit_Dates_ed.csv")

#Create a new column in each tibble that specifies whether the individual is a control or fracture patient
DM_Dates_fx <- DM_Dates_fx %>% mutate(Control = "FALSE")
Fracture_Dates_fx <- Fracture_Dates_fx %>% mutate(Control = "FALSE")
Visit_Dates_fx <- Visit_Dates_fx %>% mutate(Control = "FALSE")
DM_Dates_ed <- DM_Dates_ed %>% mutate(Control = "TRUE")
EM_Dates_ed <- EM_Dates_ed %>% mutate(Control = "TRUE")
Visit_Dates_ed <- Visit_Dates_ed %>% mutate(Control = "TRUE")

#Rename some columns
Visit_Dates_fx <- Visit_Dates_fx %>% rename(num_visits_before = num_visits_before_frac, num_visits_after = num_visits_after_frac)
Visit_Dates_ed <- Visit_Dates_ed %>% rename(num_visits_before = num_visits_before_ed, num_visits_after = num_visits_after_ed)

#Rename columns in index tibbles
Fracture_Dates_fx <- Fracture_Dates_fx %>% rename(ageatindex = ageatfracture)
EM_Dates_ed <- EM_Dates_ed %>% rename(ageatindex = ageatEM)
DM_Dates_ed <- DM_Dates_ed %>% rename(ageatindex = ageatEM)
DM_Dates_fx <- DM_Dates_fx %>% rename(ageatindex = ageatfracture)

#Bind the corresponding control and experimental data
Fracture_Dates_fx <- bind_rows(Fracture_Dates_fx, EM_Dates_ed)
DM_Dates_fx <- bind_rows(DM_Dates_fx, DM_Dates_ed)
Visit_Dates <- bind_rows(Visit_Dates_fx, Visit_Dates_ed)

#Need a line to remove duplicate IDs, be sure to select the fracture ID

rm(EM_Dates_ed, DM_Dates_ed, Visit_Dates_ed, Visit_Dates_fx)

#be sure to load Fracture_Dates_fx, Visit_Dates and DM_Dates_fx
#remove the first column
DM_Dates_fx <- DM_Dates_fx[-1]
Fracture_Dates_fx <- Fracture_Dates_fx[-1]
Visit_Dates <- Visit_Dates[-1]

#Make a column 'DM' that indicates whether the patients have DM
DM_Dates_fx <- DM_Dates_fx %>% mutate(DM = "TRUE")
#Add that column to the index tibble 'Fracture_Dates_fx'
test <- DM_Dates_fx %>% select(ID, DM)
Fracture_Dates_fx <- Fracture_Dates_fx %>% left_join(test, by = 'ID')
Fracture_Dates_fx$DM <- ifelse(is.na(Fracture_Dates_fx$DM), "FALSE", "TRUE")
rm(test)
```
#Remove patients who fractured prior to 2013 and re-filter for age
```{r 1}
#date <- ymd_hms("2013-01-01 UTC 00:00:00")
#Fracture_Dates_fx <- Fracture_Dates_fx %>% filter(DATE > date)
#numberafter2013 <-  nrow(Fracture_Dates_fx) - nrow(Fracture_Dates_fx)
#percentafter2013 <- (nrow(Fracture_Dates_fx )/nrow(Fracture_Dates_fx))*100

x<- nrow(Fracture_Dates_fx)
Fracture_Dates_fx <- Fracture_Dates_fx %>% filter(ageatindex >= 50)
num_rem <- x - nrow(Fracture_Dates_fx)
```
#Remove all patients with less than 3 prior visits and all patients without at least 1 follow-up
#Note that this is being applied to the tibble created above
```{r 2}
test <- Fracture_Dates_fx
x <- nrow(Fracture_Dates_fx)

Fracture_Dates_fx <- Visit_Dates %>%
  filter(num_visits_before >= 3 & num_visits_after >= 1) %>%
  select(ID) %>%
  inner_join(Fracture_Dates_fx, by = 'ID', keep = FALSE)
```
#Remove control patients who actually had an osteoporotic fracture
```{r 2.5}
#Don't use until updated, currently too broad
Controls_with_MOF <- Fracture_Dates_fx %>% filter(!is.na(fx_DATE))
Fracture_Dates_fx <- Fracture_Dates_fx %>% filter(is.na(fx_DATE))
```
Right now Fracture_Dates_sum contains ALL the patients in our cohort.
We should not lose any patients after this point.
It is important to note that DM_Dates_fx contain all the patients with DM, but these patients are also contained in Fracture_Dates_sum. Therefore, the sum of Fracture_Dates_fx and DM_Dates_fx should equal Fracture_Dates_sum after the next chunk.
```{r 3}
#Fracture_Dates_sum contains all patients with fractures
Fracture_Dates_sum <- Fracture_Dates_fx

Health_Control <- Fracture_Dates_sum %>% filter(Control == "TRUE" & DM == "FALSE") %>% nrow() #of controls without DM
DM_Control <- Fracture_Dates_sum %>% filter(Control == "TRUE" & DM == "TRUE") %>% nrow() #of controls with DM
Health_fx <- Fracture_Dates_sum %>% filter(Control == "FALSE" & DM == "FALSE") %>% nrow() #of Exp without DM
DM_fx <- Fracture_Dates_sum %>% filter(Control == "FALSE" & DM == "TRUE") %>% nrow() #of Exp with DM
```
Create a tibble that does not include patients with DM
```{r 3.5}

#Apply the prior criteria to DM_Dates_fx
#DM_Dates_fx will hold this data
test <- Fracture_Dates_fx %>% filter(DM == "TRUE") %>% select(ID)
DM_Dates_fx <- DM_Dates_fx %>% inner_join(test, by = 'ID')
rm(test)
#Remove patients with DM from Fracture_Dates_fx
Fracture_Dates_fx <- Fracture_Dates_fx %>% filter(DM == "FALSE")

patients_left <- nrow(DM_Dates_fx) + nrow(Fracture_Dates_fx)
#Find out why this number is different from nrow(Fracture_Dates_sum), we should not have lost any patients in this process.
```
#Output some basic descriptive stats
```{r 4}
#Change Control == ... to TRUE or FALSE depending on which cohort you want to see
Desc <- Fracture_Dates_fx %>% filter(Control == "FALSE") %>% summary()
names(dimnames(Desc)) <- c("x", "y")
Desc <- as_tibble(Desc)
Desc <- Desc[-1]
Desc <- separate(
  Desc, 
  "n",
  c("m", "n"),
  sep = ":",
  remove = TRUE,
  convert = TRUE) %>%
  na.omit() %>%
  pivot_wider(
    names_from = m, 
    values_from = n
              )

write.csv(Desc, "C:\\Users\\acriscit\\Documents\\Exp Desc.csv")
```
Descriptive stats for DM, same code as above
```{r 5}
#Change Control == ... to TRUE or FALSE depending on which cohort you want to see
Desc <- DM_Dates_fx %>% filter(Control == "TRUE") %>% summary()
names(dimnames(Desc)) <- c("x", "y")
Desc <- as_tibble(Desc)
Desc <- Desc[-1]
Desc <- separate(
  Desc, 
  "n",
  c("m", "n"),
  sep = ":",
  remove = TRUE,
  convert = TRUE) %>%
  na.omit() %>%
  pivot_wider(
    names_from = m, 
    values_from = n
              )

write.csv(Desc, "C:\\Users\\acriscit\\Documents\\Control Desc.csv")

rm(Desc)
```
ID missing data
#Change true, false or non to select the population who is missing data
#Change the tibble to determine what data you want to work with
```{r missing_data}
test <- Fracture_Dates_sum %>% filter(Control == "FALSE")

tot_na <- (test %>% filter(is.na(Risk)) %>% nrow())/nrow(test)
CODE_na <- (test %>% filter(is.na(CODE)) %>% nrow())/nrow(test)
HT_na <- (test %>% filter(is.na(HT.in)) %>% nrow())/nrow(test)
WT_na <- (test %>% filter(is.na(WT.in)) %>% nrow())/nrow(test)
AGE_na <- (test %>% filter(is.na(AGE)) %>% nrow())/nrow(test)
GENDER_na <- (test %>% filter(is.na(GENDER)) %>% nrow())/nrow(test)
Og_RACE_na <- (test %>% filter(is.na(Og_RACE)) %>% nrow())/nrow(test)

missing_data <- tibble(
  total = as.double(tot_na),
  Diagnosis = as.double(CODE_na),
  Height = as.double(HT_na),
  Weight = as.double(WT_na),
  Age = as.double(AGE_na),
  Sex = as.double(GENDER_na),
  Race = as.double(Og_RACE_na)
)
write.csv(missing_data, "C:\\Users\\acriscit\\Documents\\Exp missing_data.csv")
rm(missing_data)
rm(test)

```
t.tests and chi sq tests
example:
G_v_Risk <- tibble %>% 
  {t.test(.$column1 ~ .$column2, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}
Risk_v <- tibble(
  mod  = character(),
  data.name = character(),
  p.value = numeric(),
  conf.int1 = numeric(),
  conf.int2 = numeric(),
  estimate1 = numeric(),
  estimate2 = numeric(),
  n = numeric()
)
#Alter the variables in the first line then hit run to make comparisons for different data-sets
```{r stats}
#Change test to all, non-dm or only dm then hit run for all comparisons
test <- Fracture_Dates_sum %>% filter(!is.na(Risk))

#New values will be added to this tibble as you ask statistical questions
Desc_tibble <- tibble(
  Descriptor = character(),
  Control = numeric(),
  Exp = numeric(),
  p.value = numeric(),
  CI = character()
)

#number (n)
nExp <- test %>% filter(Control == "FALSE") %>% nrow()
nCont <- test %>% filter(Control == "TRUE") %>% nrow()

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "n",
  Control = nCont,
  Exp = nExp)

#%men
chi <- chisq.test(table(test$GENDER, test$Control))
Exp <- chi$observed[2]/nrow(test %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(test %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value[1]

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "% Men",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

#%White
test2 <- test %>% filter(Og_RACE == 'B'| Og_RACE == 'W')
chi <- chisq.test(table(test2$Og_RACE, test2$Control))
rm(test2)
Exp <- chi$observed[2]/nrow(test %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(test %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value[1]

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "% White",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

#%Black
Exp <- chi$observed[1]/nrow(test %>% filter(Control == "FALSE"))*100
Control <- chi$observed[3]/nrow(test %>% filter(Control == "TRUE"))*100

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "% Black",
  Exp = Exp,
  Control = Control,
  p.value = p.value)
rm(chi)

#Mean age
G_v_Risk <- test %>% 
  {t.test(.$ageatindex ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Mean Age",
  Exp = round(G_v_Risk$estimate[1], digits = 2),
  Control = round(G_v_Risk$estimate[2], digits = 2),
  p.value = G_v_Risk$p.value,
  CI = CI)

#Mean age Male
G_v_Risk <- test %>% filter(GENDER == 'M') %>%
  {t.test(.$ageatindex ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Mean Age Male",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

#Mean age female
G_v_Risk <- test %>% filter(GENDER == 'F') %>%
  {t.test(.$ageatindex ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Mean Age Female",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

#Mean FRAX
G_v_Risk <- test %>%
  {t.test(.$Risk ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Mean FRAX Risk",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

#FRAX>20
test <- test %>% mutate(threshold = ifelse(Risk > 20, "TRUE", "FALSE"))
chi <- chisq.test(table(test$threshold, test$Control))
Exp <- chi$observed[2]/nrow(test %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(test %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "% FRAX Risk > 20%",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

#FRAX_lower>20
test <- test %>% mutate(threshold = ifelse(Range_lower > 20, "TRUE", "FALSE"))
chi <- chisq.test(table(test$threshold, test$Control))
Exp <- chi$observed[2]/nrow(test %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(test %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "% FRAX Risk with lowest weighting > 20%",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

#Anti-osteo meds
  #Import and bind osteo_meds
Osteo_Meds_ed <- read_csv("C:/Users/acriscit/Documents/Results/Osteo_Meds_ed.csv")
Osteo_Meds_ed <-  Osteo_Meds_ed %>% mutate(Control = "TRUE")

Osteo_Meds_fx <- read_csv("C:/Users/acriscit/Documents/Results/Osteo_Meds_fx.csv")
Osteo_Meds_fx <-  Osteo_Meds_fx %>% mutate(Control = "FALSE")

Osteo_Meds <- bind_rows(Osteo_Meds_fx, Osteo_Meds_ed)
rm(Osteo_Meds_ed, Osteo_Meds_fx)
Osteo_Meds <- Osteo_Meds[-1]

  #Make a column for osteo_med start date
test <- Osteo_Meds %>% select(ID, osteo_med_start_date) %>% right_join(test, by = 'ID', .keep_all = FALSE)
  #Make a column to see if they were taking the med prior to fracture
test <- test %>% mutate(med_before = difftime(DATE, osteo_med_start_date, units = c("days")))
test <- test %>% mutate(true_med = ifelse(med_before > 0, "TRUE", "FALSE"))
test$true_med <- ifelse(is.na(test$true_med), "FALSE", test$true_med)

chi <- chisq.test(table(test$true_med, test$Control))
Exp <- chi$observed[2]/nrow(test %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(test %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "% Taking anti-osteo med prior to fracture or index date",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

#Anti-osteo meds DM vs not
test2 <- test %>% filter(Control == "TRUE")
chi <- chisq.test(table(test$true_med, test$DM))
Exp <- chi$observed[2]/nrow(test2 %>% filter(DM == "TRUE"))*100
Control <- chi$observed[4]/nrow(test2 %>% filter(DM == "FALSE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "% Controls (DM vs nonDM) Taking anti-osteo med prior to index date",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

test2 <- test %>% filter(Control == "FALSE")
chi <- chisq.test(table(test$true_med, test$DM))
Exp <- chi$observed[2]/nrow(test2 %>% filter(DM == "TRUE"))*100
Control <- chi$observed[4]/nrow(test2 %>% filter(DM == "FALSE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "% FX pts (DM vs nonDM) Taking anti-osteo med prior to index date",
  Exp = Exp,
  Control = Control,
  p.value = p.value)
rm(test2)

#Mean time on anti-osteo med prior to fracture
test2 <- test %>% filter(true_med == "TRUE")
G_v_Risk <- test %>% 
  filter(true_med == "TRUE") %>%
  {t.test(.$med_before ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- as.double(G_v_Risk$conf.int[1])
CI2 <- as.double(G_v_Risk$conf.int[2])
CI <- toString(c(CI1, CI2))
Exp <- as.double(G_v_Risk$estimate[1])
Control <- as.double(G_v_Risk$estimate[2])

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Mean days on anti-osteo med prior to first fracture or index date",
  Exp = Exp,
  Control = Control,
  p.value = as.double(G_v_Risk$p.value),
  CI = CI)
rm(test2)

#Mean BMI
G_v_Risk <- test %>%
  {t.test(.$BMI ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Mean BMI",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

#%DXA prior to fracture
#Need line to import DXA data
#DXA <- DXA[-1]
#DXA <- rename(DXA, DXA_DATE = DATE)
#test <- DXA %>% group_by(ID) %>% arrange(DXA_DATE, .group_by = TRUE) %>% distinct(ID, .keep_all = TRUE) %>% select(ID, DXA_DATE) %>% right_join(test, by = 'ID')
#test <- test %>% mutate(DXA_before_fx = DATE - DXA_DATE)
#test <- test %>% mutate(true_DXA = ifelse(DXA_before_fx > 0, "TRUE", "FALSE"))

#chi <- chisq.test(table(test$true_DXA, test$Control))
#Exp <- chi$observed[2]/nrow(test %>% filter(Control == "FALSE"))*100
#Control <- chi$observed[4]/nrow(test %>% filter(Control == "TRUE"))*100
#p.value <- chi$p.value

#Desc_tibble <- Desc_tibble %>% add_row(
#  Descriptor = "% with DXA prior to fracture",
#  Exp = Exp,
#  Control = Control,
#  p.value = p.value)

#Risk of death 1 year after fx
test <- test %>% mutate(time_to_death = ageatdeath-ageatindex) %>%
 mutate(Death1 = ifelse(time_to_death <= 1, "TRUE", "FALSE")) %>%
 mutate(Death5 = ifelse(time_to_death <= 5, "TRUE", "FALSE"))
test$Death1 <- ifelse(is.na(test$Death1), "FALSE", test$Death1)
test$Death5 <- ifelse(is.na(test$Death5), "FALSE", test$Death5)

chi <- chisq.test(table(test$Death1, test$Control))
Exp <- chi$observed[2]/nrow(test %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(test %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Risk of death in 1 year",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

#Risk of death 5 years after fx
chi <- chisq.test(table(test$Death5, test$Control))
Exp <- chi$observed[2]/nrow(test %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(test %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Risk of death in 5 years",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

#Risk of death overall
test <- test %>% mutate(Death = ifelse(is.na(ageatdeath), "FALSE", "TRUE"))

chi <- chisq.test(table(test$Death, test$Control))
Exp <- chi$observed[2]/nrow(test %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(test %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Risk of death overall",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

#HBA1C vs Fracture
G_v_Risk <- DM_Dates_fx %>%
  {t.test(.$HBA1C_max ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Max HBA1C",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

#Long term insulin vs fracture
chi <- chisq.test(table(DM_Dates_fx$long_term_insulin, DM_Dates_fx$Control))
Exp <- chi$observed[2]/nrow(DM_Dates_fx %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(DM_Dates_fx %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Long term inslin vs fracture",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

#Diabetics Age vs fracture
G_v_Risk <- DM_Dates_fx %>% filter(DM == "TRUE") %>%
  {t.test(.$ageatindex ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Mean age of diabetics",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

#nonDiabetics Age vs fracture
G_v_Risk <- DM_Dates_fx %>% filter(DM == "FALSE") %>%
  {t.test(.$ageatindex ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Mean age of non-diabetics",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

#Diabetics sex vs fracture
test2 <- test %>% filter(DM == "TRUE")
chi <- chisq.test(table(test2$GENDER, test2$Control))
Exp <- chi$observed[2]/nrow(test2 %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(test2 %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Diabetics sex vs fracture",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

#Diabetics race vs fracture
test2 <- test %>% filter(DM == "TRUE" & Og_RACE == "W"|Og_RACE == "B")
chi <- chisq.test(table(test2$Og_RACE, test2$Control))
Exp <- chi$observed[2]/nrow(test2 %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(test2 %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "Diabetics race vs fracture",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

#nonDiabetics sex vs fracture
test2 <- test %>% filter(DM == "FALSE")
chi <- chisq.test(table(test2$GENDER, test2$Control))
Exp <- chi$observed[2]/nrow(test2 %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(test2 %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "nonDiabetics sex vs fracture",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

#Nondiabetics race vs fracture
test2 <- test %>% filter(DM == "FALSE" & Og_RACE == "W"|Og_RACE == "B")
chi <- chisq.test(table(test2$Og_RACE, test2$Control))
Exp <- chi$observed[2]/nrow(test2 %>% filter(Control == "FALSE"))*100
Control <- chi$observed[4]/nrow(test2 %>% filter(Control == "TRUE"))*100
p.value <- chi$p.value

Desc_tibble <- Desc_tibble %>% add_row(
  Descriptor = "nonDiabetics race vs fracture",
  Exp = Exp,
  Control = Control,
  p.value = p.value)

write.csv(Desc_tibble, "C:\\Users\\acriscit\\Documents\\Desc_tibble.csv")
```
Histogram
```{r histogram}
ggplot(data = test, aes(x=Risk, fill=Control)) + 
  geom_histogram() +
  labs(title = "FRAX Risk Score", x="FRAX score", y="Count") +
  scale_fill_manual(name="Legend",values=c("red","darkgray"),labels=c("Fracture","Control"))

ggplot(data = test, aes(x=ageatindex, fill=Control)) + 
  geom_histogram() +
  labs(title = "FRAX Risk Score", x="Age", y="Count") +
  scale_fill_manual(name="Legend",values=c("salmon","lightblue"),labels=c("Fracture","Control"))
```
Kolmogrov-Smirnov test for normality on above data
```{r normal}

ks.test(test$Risk, 'pnorm', mean=mean(test$Risk), sd=sd(test$Risk))

shapiro.test(test$Risk)

#test for skew of the data
install.packages("tseries")
library(tseries)
jarque.bera.test(test$Risk)
```
Chronology
```{r chron}
  
rm(test)
#Create a histogram that outlines the chronology of fractures
test$DATE <- test$DATE %>% as.Date()
library(scales)

date_mean <- test %>% filter(Control == "FALSE")
date_mean <- date_mean$DATE %>% mean()

ggplot(test %>% filter(Control == "FALSE"), aes(x=DATE)) + 
  geom_histogram(binwidth=30, colour="blue") +
  scale_x_date(labels = date_format("%Y")) +
  labs(title = "Fracture Chonology", x="Time", y="Count") +
  
  geom_vline(xintercept=date_mean, size=1, color="black")+
  geom_text(aes(x=date_mean - 3000,label=paste0("Mean:  ",date_mean), y=20))

```
Box plots
```{r plot}
plot_tibble <- tibble(
  Descriptor = character(),
  Control = numeric(),
  Exp = numeric(),
  p.value = numeric(),
  CI = character()
)

#PLOT1: Control vs Frax score box plot (Chnage Control to fracture vs no fracture)
plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "PLOT1")
  
ggplot(data = test, aes(Control, Risk)) +
geom_jitter(width=.3,
                 col="black", 
                 fill="dodgerblue", 
                 alpha = .5) +
geom_boxplot(col="blue", alpha = .5) +
  labs(title = "Fracture vs FRAX score", x="", y="FRAX") +
  scale_x_discrete(labels=c("Fracture", "Control"))

G_v_Risk <- test %>%
  {t.test(.$Risk ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "frax vs control",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

#Make 4 plots based on Control and sex
smooth <- test %>% unite('SEX_Control', c(GENDER,Control), remove = FALSE) %>% unite('DM_Control', c(DM,Control), remove = FALSE) %>% select(ID,SEX_Control,DM_Control,ageatindex,Risk,DM) %>% filter (!is.na(Risk))

#PLOT2
plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "PLOT2")
  
ggplot(data = smooth, aes(SEX_Control,Risk)) +
geom_boxplot() +
  labs(title = "Sex, Control and Risk", x="Sex and Fracture", y="FRAX") +
  scale_x_discrete(labels=c("F fracture","F control","M fracture","M control"))

#t tests in same order as boxplot
G_v_Risk <- test %>% filter(GENDER == "F") %>%
  {t.test(.$Risk ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "F frax vs control",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

G_v_Risk <- test %>% filter(GENDER == "M") %>%
  {t.test(.$Risk ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "M frax vs control",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

G_v_Risk <- test %>% filter(Control == "TRUE") %>%
  {t.test(.$Risk ~ .$GENDER, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "Control, frax vs Sex",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

G_v_Risk <- test %>% filter(Control == "FALSE") %>%
  {t.test(.$Risk ~ .$GENDER, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "Fracture, frax vs Sex",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

#PLOT3
plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "PLOT3")

ggplot(data = smooth, aes(DM_Control,Risk)) +
geom_boxplot() +
  labs(title = "DM, fracture and Risk", x="DM and Fracture", y="FRAX") +
  scale_x_discrete(labels=c("No DM fracture","No DM control","DM fracture","DM control"))

#t tests in same order as boxplot
G_v_Risk <- test %>% filter(DM == "FALSE") %>%
  {t.test(.$Risk ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "NonDM, frax vs control",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

G_v_Risk <- test %>% filter(DM == "TRUE") %>%
  {t.test(.$Risk ~ .$Control, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "DM, frax vs control",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

G_v_Risk <- test %>% filter(Control == "TRUE") %>%
  {t.test(.$Risk ~ .$DM, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "Control, frax vs DM",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

G_v_Risk <- test %>% filter(Control == "FALSE") %>%
  {t.test(.$Risk ~ .$DM, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "Fracture, frax vs DM",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

rm(smooth)

#PLOT4
plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "PLOT4")

test2 <- test %>% filter(Control =="FALSE")

ggplot(data = test2, aes(DM,ageatindex)) +
  geom_jitter(width=.3,
                 col="black", 
                 fill="dodgerblue", 
                 alpha = .5) +
geom_boxplot(alpha = .5) +
  labs(title = "Age at Fracture", x="", y="Age") +
  scale_x_discrete(labels=c("non Diabetic","Diabetic"))

#t tests in same order as boxplot
G_v_Risk <- test2 %>%
  {t.test(.$ageatindex ~ .$DM, alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)}

CI1 <- round(as.double(G_v_Risk$conf.int[1]), digits = 2)
CI2 <- round(as.double(G_v_Risk$conf.int[2]), digits = 2)
CI <- toString(c(CI1, CI2))

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "Age of fracture",
  Exp = G_v_Risk$estimate[1],
  Control = G_v_Risk$estimate[2],
  p.value = G_v_Risk$p.value,
  CI = CI)

```
ROC
```{r ROC}
library(pROC)

#ROC Control vs FRAX (substitute fracture for Control)
roc <- test %>%
  roc(Control, Risk, levels=c("TRUE", "FALSE")) 
roc %>% ggroc()

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "ROCs")

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "FRAX vs fracture, AUC ->",
  Control = as.double(roc$auc)
)

#ROC, no DM
roc <- test %>% filter(DM == "FALSE") %>%
  roc(Control, Risk, levels=c("TRUE", "FALSE")) 
roc %>% ggroc()

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "no DM, FRAX vs fracture, AUC ->",
  Control = as.double(roc$auc)
)

#ROC DM
roc <- test %>% filter(DM == "TRUE") %>%
  roc(Control, Risk, levels=c("TRUE", "FALSE")) 
roc %>% ggroc()

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "DM, FRAX vs fracture, AUC ->",
  Control = as.double(roc$auc)
)

#ROC range_upper (heaviest weighting)
roc <- test %>%
  roc(Control, Range_upper, levels=c("TRUE", "FALSE")) 
roc %>% ggroc()

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "Upper range vs fracture, AUC ->",
  Control = as.double(roc$auc)
)

roc <- DM_Dates_fx %>% filter(HBA1C_max > 6.5) %>%
  roc(Control, Risk, levels=c("TRUE", "FALSE")) 
roc %>% ggroc()

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "HBA1c > 6.5, FRAX vs fracture, AUC ->",
  Control = length(roc$controls),
  Exp = length(roc$cases),
  p.value = as.double(roc$auc)
)

roc <- DM_Dates_fx %>% filter(HBA1C_max > 8) %>%
  roc(Control, Risk, levels=c("TRUE", "FALSE")) 
roc %>% ggroc()

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "HBA1c > 8, FRAX vs fracture, AUC ->",
  Control = length(roc$controls),
  Exp = length(roc$cases),
  p.value = as.double(roc$auc)
)

#ROC Control vs FRAX -5 years (substitute fracture for Control)
#You can do this for each year leading up to fracture and determine the predictive value of FRAX for each year

```
survival curve
```{r survival}

```
Linear regression
```{r regression}
#Implement multiple regression
#Regress FRAX vs comorbidities
#Age vs FRAX Risk score
lm_FRAX <- lm(Risk ~ ageatindex, data = test)
summary <- summary(lm_FRAX)

ggplot(lm_FRAX, aes(x=ageatindex, y=Risk)) +
  geom_point(size = 0.25)+
  geom_smooth(method="lm", color = "#9D7C2F") +
  xlab("Age (years)") +
  ylab("FRAX score") +
  theme_bw() +
  ggtitle("Age vs FRAX score") +
  geom_text(aes(label=paste0("R^2:  ",round(summary$r.squared, digits = 3)), y=80, x=90))

plot_tibble <- plot_tibble %>% add_row(
  Descriptor = "Age vs FRAX, R ->",
  p.value = summary$r.squared
)

#FRAX Score vs time to death
lm_FRAX <- lm(time_to_death ~ Risk , data = test %>% filter(time_to_death >= 0 & Control == "FALSE" & DM == "FALSE"))
summary <- summary(lm_FRAX)

ggplot(lm_FRAX, aes(x=time_to_death, y=Risk)) +
  geom_point(size = 0.25)+
  geom_smooth(method="lm", color = "#9D7C2F") +
  xlab("Time to death (years)") +
  ylab("FRAX score") +
  theme_bw() +
  ggtitle("Patients with Fracture, not DM, Time to death vs FRAX score") +
  geom_text(aes(label=paste0("R^2:  ",round(summary$r.squared, digits = 3)), y=80, x=20))

plot_tibble <- plot_tibble %>% add_row(
    Descriptor = "Patients with Fracture, not DM, Time to death vs FRAX score R ->",
    p.value = summary$r.squared
)

lm_FRAX <- lm(time_to_death ~ Risk , data = test %>% filter(time_to_death >= 0 & Control == "FALSE" & DM == "TRUE"))
summary <- summary(lm_FRAX)

ggplot(lm_FRAX, aes(x=time_to_death, y=Risk)) +
  geom_point(size = 0.25)+
  geom_smooth(method="lm", color = "#9D7C2F") +
  xlab("Time to death (years)") +
  ylab("FRAX score") +
  theme_bw() +
  ggtitle("Patients with Fracture and DM, Time to death vs FRAX score") +
  geom_text(aes(label=paste0("R^2:  ",round(summary$r.squared, digits = 3)), y=80, x=20))

plot_tibble <- plot_tibble %>% add_row(
    Descriptor = "Patients with Fracture and DM, Time to death vs FRAX score, R ->",
    p.value = summary$r.squared
)

#In the control group, people fractured after being seen in the ED. The below graph depicts the correlation between "time to fracture" and FRAX score
lm_FRAX <- lm(fx_time ~ Risk , data = test %>% filter(fx_time >= 1))
summary <- summary(lm_FRAX)
n <- nrow(lm_FRAX$model)

ggplot(lm_FRAX, aes(x=fx_time, y=Risk)) +
  geom_point(size = 0.25)+
  geom_smooth(method="lm", color = "#9D7C2F") +
  xlab("Time to fracture (days)") +
  ylab("FRAX score") +
  theme_bw() +
  ggtitle("Time from index date to fracture") +
  geom_text(aes(label=paste0("R^2:  ",round(summary$r.squared, digits = 3)), y=60, x=2000))

plot_tibble <- plot_tibble %>% add_row(
    Descriptor = "time to fx, R ->",
    Control = n,
    p.value = summary$r.squared
)

rm(summary, lm_FRAX, G_v_Risk, roc)


#Finally, use your cohort of non-fractured diabetics to assess the predictive value of FRAX with
  #1) A survival curve (where fracture is supplemented for survicval)
  #2) Linear regression of FRAX score vs time to fracture from index date
```
Osteo_meds
```{r meds}
#Osteo_meds should have been uploaded prior

ggplot(data = test %>% filter(med_before >= 0), aes(Risk, Control)) +
  geom_violin(col="dodgerblue", 
                 fill="dodgerblue", 
                 alpha = .5) +
  labs(title = "FRAX Risk Score", x="FRAX score", y="Anti-osteoporotic Medication") +
  scale_x_discrete(labels=c("No DM fracture","No DM control","DM fracture","DM control"))


  stat_boxplot(width=.2, col="black", fun.data = mean_se, geom = "errorbar", size=.5) +
  geom_boxplot(width=.3,
                 col="black", 
                 fill="dodgerblue", 
                 alpha = 1)



#Antiosteoporotic meds for pts with risk > 20
ggplot() +
  geom_violin(data = Fracture_Dates_fx20, aes(Risk,oste_med),
                 col="blue", 
                 fill="blue", 
                 alpha = .4) +
  labs(title = "Patients with FRAX Risk > 20%", x="FRAX score", y="Anti-osteoporotic Medication") +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75))

#Box plot Control, sex and FRAX score
smooth <- Fracture_Dates_fx %>% unite('SEX_Control', c(GENDER,Control), remove = TRUE) %>% select(ID,SEX_Control,AGE,Risk) %>% filter (!is.na(Risk))

smooth_plot <- ggplot(data = smooth, aes(SEX_Control,AGE)) +
geom_boxplot() +
  labs(title = "Sex, Control and Age", x="Sex and Diabetes", y="Age") +
  scale_x_discrete(labels=c("F Control","F","M Control","M"))
```
Plotting a smooth curve
```{r smooth}
smooth <- Fracture_Dates_fx %>% unite('SEX_Control', c(GENDER,Control), remove = TRUE) %>% select(ID,SEX_Control,AGE,Risk) %>% pivot_longer(cols = c(SEX_Control,AGE,Risk), names_to = "Variable", values_to = "Value", values_drop_na = TRUE)

ggplot(Fracture_Dates_fx, aes(x=AGE, y=Risk)) +
  #geom_point() +
  geom_smooth(se=FALSE, col='red', size=2) +
  geom_hline(xintercept, linetype, color, size)


```
#Linear regression FRAX score and death
```{r anova}

#Anova Control, Age, Risk
G_v_Risk <- aov(Risk ~ Control * AGE, data = Fracture_Dates_fx)
summary(G_v_Risk)
#Note that group 1 is Alive and group 2 is Dead. I think they are sorted alphabetically
Risk_v <- Risk_v %>% add_row(
  mod = '5 years post fx',
  data.name = G_v_Risk$data.name,
  p.value = G_v_Risk$p.value,
  conf.int1 = G_v_Risk$conf.int[1],
  conf.int2 = G_v_Risk$conf.int[2],
  estimate1 = G_v_Risk$estimate[1],
  estimate2 = G_v_Risk$estimate[2],
  n = nrow(Fracture_Dates_fx)
)

#Anova Risk, time to death, Control
G_v_Risk <- aov(Risk ~ Control * TIME_TO_DEATH, data = Fracture_Dates_fx)
summary(G_v_Risk)

#Anova Risk, Time to death, Race
G_v_Risk <- aov(Risk ~ Og_RACE * TIME_TO_DEATH, data = Fracture_Dates_fx)
summary(G_v_Risk)

#Anova Risk, Control, Race
G_v_Risk <- aov(Risk ~ Og_RACE * Control, data = Fracture_Dates_fx)
summary(G_v_Risk)

#Question: What are the risk of being black and having Control

#Question: Are those taking meds more likely to be white?

#Question: Are those without DM more likely to be taking anti-osteoporotic meds

#Number with FRAX score that warranted treatment
#test whether there is a difference between those with DM and Risk >20 requires chi test

#Osteoporosis meds

```
Plotting linear regression

DXA
tibble_names$Procedures %>% filter(grepl('DXA', DESC)) %>% select(DATE, ID)
``` {r linear regression}




#DM linear regression
fxfinal <- transform(na.omit(fx), ID = as.character(ID))

ID_DM_HBA1C <- DM_Dates_fx %>% filter(HBA1C_avg > 0)

lm_ABA1Cavg_Age <- lm(Risk ~ HBA1C_avg, data = ID_DM_HBA1C)
summary(lm_ABA1Cavg_Age)

ggplot(lm_ABA1Cavg_Age, aes(x=HBA1C_avg, y=Risk)) +
  geom_point(size = 0.25)+
  geom_smooth(method="lm", color = "#9D7C2F") +
  xlab("HbA1C mean (%)") +
  ylab("FRAX score") +
  theme_bw() +
  ggtitle("Mean HbA1C vs FRAX score")


lm_ABA1Cavg_max <- lm(Risk ~ HBA1C_max, data = ID_DM_HBA1C)
summary(lm_ABA1Cavg_max)

ggplot(lm_ABA1Cavg_max, aes(x=HBA1C_max, y=Risk)) +
  geom_point(size = 0.25)+
  geom_smooth(method="lm", color = "#9D7C2F") +
  xlab("HbA1C max (%)") +
  ylab("FRAX score") +
  theme_bw() +
  ggtitle("HbA1C vs FRAX score")


lm_ABA1Cavg_time <- lm(Risk ~ Duration, data = DM_Dates_fx)
summary(lm_ABA1Cavg_time)

ggplot(lm_ABA1Cavg_time, aes(x=Duration, y=Risk)) +
  geom_point(size = 0.25)+
  geom_smooth(method="lm", color = "#9D7C2F") +
  xlab("Time (seconds)") +
  ylab("FRAX score") +
  theme_bw() +
  ggtitle("DM duration vs FRAX score")

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.