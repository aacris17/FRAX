---
title: "FRAX calculator for I2b2 results 1/10/21"
author: "Anthony Criscitiello and Ellen Quillen"
date: "1/10/2021"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
title: "FRAX calculator for I2b2 results"
output: html_document
---
```{r library}
library(tidyverse)
library(readxl)
library(lubridate)
library(tibble)
library(purrr)
```
Here is cheatsheet on options for R markdown: https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf
##Introduction
```{r load FRAX ppr charts and patient data}
#load FRAX paper charts (10-year risk of major osteoporotic fracture based on BMI)
#FRAX <-  read_csv("E:/Dropbox/Students/Anthony/FRAX.csv", header = TRUE, stringsAsFactors = FALSE)
FRAX <-  read_csv("C:\\Users\\acriscit\\Documents\\FRAX.csv", col_types = "ccdddddd")
names(FRAX)<- c("GENDER", "RACE", "AGE","CRF","BMI","Risk", "Range_upper", "Range_lower")
view(FRAX)

#Load I2b2 data
#Patient cohort: DM2 and osteoporotic fracture
FRAX_data <- "C:\\Users\\acriscit\\Documents\\20201020180719000_acriscit.xlsx"

#Label each list element with it's associated tab from the excel sheet
tab_names <- excel_sheets(path = FRAX_data)
#Below is the slow line
FRAX_data <- map(tab_names, ~read_excel(path = FRAX_data, sheet = .x))
FRAX_data <- FRAX_data %>% set_names(tab_names)
```
I2b2 generates excel files with many tabs. The below chunk will start to process it into a more readable ('tidy') form. R converts each tab into a list element.
```{r tidy_frax}
#Collect the tabs from 'xl_data' that contain info used to calculate FRAX score. This includes Diagnoses, Labs, Meds, Vitals and Smoking history
tab_names2 <- tibble(
Row = (1:length(tab_names)),
tab_names = tab_names
)

Frax_tabs <- tab_names2 %>% 
    filter(
    grepl('Diagnoses', tab_names) | 
    grepl('Labs', tab_names) | 
    grepl('Meds', tab_names) | 
    grepl('Vitals', tab_names) | 
    grepl('Smoking', tab_names)
  )
FRAX_pts <- FRAX_data[c(Frax_tabs$Row)]

#Selecting specific colums below. This will make tabs uniform and mergeable
for (i in 1:length(FRAX_pts)){
 FRAX_pts[[i]] <- FRAX_pts[[i]] %>% select(
  contains(
    c(
      'PATIENT',
      'VISIT',
      'DATE',
      'CODE',
      'DESC', 
      'TEXT', 
      'NUMERIC', 
      'UNITS',
      'MODIFIER'
      )
    )
  )
}

#rename columns and remove spaces from column names
col_names <- c(
  "ID", 
  "VISIT", 
  "DATE",
  "CODE",
  "DESC", 
  "TEXT_VALUE", 
  "NUMERIC_VALUE", 
  "UNITS",
  "MODIFIER"
)
#This loop applies the new column names to each list element in FRAX_pts
for (i in 1:length(FRAX_pts)){
  names(FRAX_pts[[i]]) <- col_names[1:ncol(FRAX_pts[[i]])]
}

#Condense the 'list' into a 'tibble' using 'bind_rows'
x <- bind_rows(FRAX_pts)

#Use lubridate to convert dates from characters to dates
x$DATE <- mdy_hm(x$DATE, quiet = TRUE
)

#Collect the tabs containing demographic info used to calculate FRAX score from 'FRAX_data'
info_tabs <- tab_names2 %>% filter(grepl('Patients', tab_names))
FRAX_info <- FRAX_data[c(info_tabs$Row)]

#Rename columns
col_names <- c(
  "ID", 
  "AGE_NOW", 
  "AGE_AT_DEATH",
  "BIRTH_DATE",
  "DEATH_DATE",
  "MATCH",
  "GENDER", 
  "RACE", 
  "MIXED RACE", 
  "ETHNICITY"
)

#Apply the new column names to each list element in FRAX_info
for (i in 1:length(FRAX_info)){
  names(FRAX_info[[i]]) <- col_names[1:ncol(FRAX_info[[i]])]
}

#Combine list elements of FRAX_info into one tibble
y <- bind_rows(FRAX_info)

#Convert dates from character to date format
y$BIRTH_DATE <- mdy_hm(y$BIRTH_DATE, quiet = TRUE
)
```
Now that the patient data is more readable, we will create a tibble that contains data needed to calculate a FRAX score for each patient. This will primarily be accomplished with the use of a loop.
```{r loop preparation}
#Create a tibble ('Fracture_Dates') with columns for the date of the most recent fracture for each patient and associated FRAX score variables
Fracture_Dates <- tibble(
  ID = numeric(),
  DATE = mdy_hms(),
  CODE = character(),
  DESC = character(),
  HT.in = numeric(), 
  WT.in = numeric(),
  AGE = numeric(), 
  GENDER = character(), 
  Og_RACE = character(), 
  CRF = numeric(),
  #CRF is Combined Risk Factors
  BMI = numeric(),
  first_visit_date = mdy_hms(),
  last_visit_date = mdy_hms(),
  num_visits_before_frac = numeric(),
  num_visits_after_frac = numeric(),
  osteo_med_start_date = mdy_hms(),
  osteo_med_start_dose = numeric(),
  osteo_med_last_date = mdy_hms()
)

#The below lines will select patients with fracture then remove instances with traumatic fracture or fractures of the hands, feet, face or skull. It is assumed that all other fractures in this >50 y/o population are major osteoporotic fractures. Like the below lines it will then group fracture events by patient ID and arrange them by date, allowing us to select the first fracture if there are multiple using 'distinct ()'
ID_fracs <- x %>%
  filter(grepl('[Ff]racture', DESC)) %>%
  #Exclude S62 hand, S92, S99 foot, M88 Osteodeformans/Paget's disease of bone, S02 Face/skull, V trauma due to a collision, Y04 assault by bodily force
  filter(!grepl('S62|S92|S99|M88|S02|V|Y04', CODE)) %>%
  select(ID, DATE, CODE, DESC) %>% 
  group_by(ID) %>% 
  arrange(DATE, .by_group = TRUE) %>% 
  distinct(ID, .keep_all = TRUE)

#The below line will select patients with hip fracture
Hip_fracs <- x %>%
  #filter for ICD code M84.x59 which indicates a hip fracture where x = 3,4,5 or 6
  filter((grepl('M84&59', CODE))) %>%
  select(ID, DATE, CODE, DESC) %>% 
  group_by(ID) %>% 
  arrange(DATE, .by_group = TRUE) %>% 
  distinct(ID, .keep_all = TRUE)
```
The below loop is will collect and distill information relevant to calculating FRAX score FOR PATIENTS WHO HAVE HAD A FRACTURE ONLY. Each cycle of this loop will collect data for 1 patient
```{r frax_loop}
for (i in 1:nrow(ID_fracs)){
  id <- as.double(ID_fracs$ID[i])

x_ID <- ID_fracs %>% 
    filter(ID == id)
  
date <- x_ID$DATE[1]
CODE <- x_ID$CODE[1]
DESC <- x_ID$DESC[1]

#Information about number of visits and date of visits relative to fracture date
visits <- x %>% 
    filter(ID == id) %>% 
    arrange(DATE)

first_visit_date <- visits$DATE[1]
last_visit_date <- (
  visits %>% 
    arrange(desc(DATE))
  )$DATE[1]
num_visits_before_frac <- visits %>% 
  filter(DATE < date) %>% 
  nrow()
num_visits_after_frac <- visits %>% 
  filter(DATE > date) %>% 
  nrow()


#Height and weight closest to the time of fracture
HT <- (x %>% 
         filter(CODE == "HT", ID == id) %>% 
         arrange(desc(DATE)) %>% 
         select(NUMERIC_VALUE)
       )[1,1]
WT <- (x %>% 
         filter(CODE == "WT", ID == id, DATE <= date) %>% 
         arrange(desc(DATE)) %>% 
         select(NUMERIC_VALUE)
       )[1,1]

#If there is no height or weight prior to the fracture date, use the oldest measurement
HT <- as.double(ifelse(is.na(HT), ((
  x %>% 
    filter(CODE == "HT", ID == id) %>% 
    arrange(desc(DATE)) %>% 
    select(NUMERIC_VALUE))[1,1]),
  HT))
WT <- as.double(ifelse (is.na(WT), ((
  x %>% 
    filter(CODE == "WT", ID == id) %>% 
    arrange(desc(DATE)) %>% 
    select(NUMERIC_VALUE))[1,1]), 
  WT))

#Calculate BMI
BMI <- (703*as.double(WT)/as.double(HT)^2)

yID <- y %>% filter(ID == id)
#Calcuate age at time of fracture
#ageatfracture <- as.double.difftime(date - (yID %>% select(BIRTH_DATE))[[1]])/365.25
ageatfracture <- as.double.difftime(as.double(yID %>% select(AGE_NOW))[[1]] - (2021 - as.double(year(date))))

#Select gender
#Change 'MATCH' back to 'GENDER'
Gender <- yID %>% select(MATCH)

#Select race
#Change 'GENDER' back to 'RACE'
Race <- yID %>% select(GENDER)

#Tibble where the risk factors will be compiled
CRF <- tibble(
  Fracture = character(),
  Smoker = character(),
  EToH = character(),
  RA = character(),
  Osteoporosis = character(),
  Parent_Osteoporosis = character(),
  Glucocorticoid = character()
)
#Collect risk factors into above tibble. If there is no observation prior to DATE, it is assumed that the risk factor was not present. For example, if there is no prior fracture documented, it is assumed that there was no prior fracture

# alternative to 'filter(grepl())' is library(stringr), x %>% filter(str_detect(rowname, "^ICD-10 code")). '^' means starts with

ID_data <- x %>% filter(ID == id & DATE < date)
#Identify any previous fracture
Fracture <- as.character(
  (ID_data %>% 
     filter(grepl('[Ff]racture', DESC)) %>% 
     select(DESC))[1,1]
  )
#Any smoking history
Smoker <- as.character(
  (ID_data %>% 
     filter(grepl('[Ss]moker', DESC) & !grepl('Never', DESC)) %>% 
     select(DESC))[1,1]
  )
#A diagnosis of alcohol use (ICD-10 codes containing F10 or corresponding ICD-9 codes (303 alcohol dependance, 291 alcohol induced mental disorder, 3050 alcohol abuse), which encompasses alcohol abuse, alcohol dependence and alcohol use, unspecified) is used as a surrogate for "3 or more units of alcohol per day" as specified by FRAX
EToH <- as.character(
  (ID_data %>% 
     filter(grepl('F10|3050|291|303', CODE)) %>%
     select(CODE))[1,1]
  )
#A diagnosis of Rheumatoid Arthritis 
RA <- as.character(
  (ID_data %>% 
     filter(grepl('M05|M06|714', CODE)) %>%
     select(CODE))[1,1]
  )
#According to FRAX this includes osteoporosis (M81, 7330) and diseases strongly associated with osteoporosis including type I (insulin dependent) diabetes (E10, 250), osteogenesis imperfecta in adults (Q78.0, 75651), untreated long-standing hyperthyroidism E05, 242)(these are the codes for hyperthyroidism irrespective of treatment), hypogonadism (E29.1, 2572 (male), E28.3, 25631, 25639 (female) including) premature menopause (<45 years), chronic malnutrition (intestinal malabsorption K90, 579, nutritional malabsorption E41-46, 261-263), or malabsorption and chronic liver disease
#An alternative to malabsorption could be to consider BMI <15
Osteoporosis <- as.character(
  (ID_data %>% 
     filter(grepl('M81|7330|E10|250|Q78.0|75651|E05|242|E29.1|2572|E28.3|25631|25639|k90|579|E41|E42|E43|E44|E45|E46|261|262|263', CODE)) %>% 
     select(CODE))[1,1]
  )
#FRAX considers parental hip fracture a risk. We have substituted parental osteoporosis for this risk factor because there is a searchable diagnostic code
Parent_Osteoporosis <- as.character(
  (ID_data %>% 
     filter(grepl('Z82.62|V17.81', CODE)) %>% 
     select(CODE))[1,1]
  )
#Current exposure to oral glucocorticoids or exposure to oral glucocorticoids for more than 3 months at a dose eqivalent to prednisolone > 5mg daily
Glucocorticoid_data <- ID_data %>% 
     filter(UNITS == 'mg' &
              grepl('[Bb]eclomethasone|[Bb]etamethasone|[Bb]udesonide|[Cc]ortisone|[Dd]examethasone|[Hh]ydrocortisone|[Mm]ethylprednisolone|[Pp]rednisolone|[Pp]rednisone|[Tt]riamcinolone', DESC) &
              grepl('[Ii]njection| [Tt]ablet| [Ii]vbp', DESC)
     )
#Exclude glucocorticoids taken for less than 3 months
Glucocorticoid_start_date <- (Glucocorticoid_data %>% arrange(DATE) %>% select(DATE))[[1,1]]
Glucocorticoid_stop_date <- (Glucocorticoid_data %>% arrange(desc(DATE)) %>% select(DATE))[[1,1]]
Glucocorticoid_duration <- (Glucocorticoid_stop_date - Glucocorticoid_start_date)
Glucocorticoid <- ifelse(Glucocorticoid_duration > days(90), Glucocorticoid_duration, "NA")

#Add each risk factor to the 'CRF' tibble
CRF <- CRF %>% add_row(
Fracture = Fracture,
Smoker = Smoker,
EToH = EToH,
RA = RA,
Osteoporosis = Osteoporosis,
Parent_Osteoporosis = Parent_Osteoporosis,
Glucocorticoid = Glucocorticoid
)
#Convert risk factors to 0 (not present) or 1 (present)
CRF[!is.na(CRF)] <- '1'
CRF[is.na(CRF)] <- '0'
#Calculate CRF
CRF_score <- sum(as.double(CRF))

#FDA approved osteoporosis medication usage
osteo_med <- x %>% 
  filter(
  grepl('[Ee]tidronate|[Aa]lendronate|[Ii]bandronate|[Zz]oledronic|[Rr]isedronate|[Cc]alcitonin|[Dd]enosumab', DESC)
  )
osteo_med_start_date <- (osteo_med %>% 
                           arrange(DATE) %>% 
                           select(DATE))[[1,1]]
osteo_med_start_dose <- (osteo_med %>% 
                           arrange(DATE) %>% 
                           select(NUMERIC_VALUE))[[1,1]]
osteo_med_last_date <- (osteo_med %>% 
                           arrange(desc(DATE)) %>% 
                           select(DATE))[[1,1]]

#Put all the data you collected into 'Fracture_Dates'
Fracture_Dates = Fracture_Dates %>% add_row(
ID = id,
DATE = date,
CODE = CODE,
DESC = DESC,
HT.in = as.double(HT), 
WT.in = as.double(WT), 
AGE = as.double(ageatfracture), 
GENDER = as.character(Gender), 
Og_RACE = as.character(Race), 
CRF = as.double(CRF_score),
BMI = as.double(BMI),
first_visit_date = first_visit_date,
last_visit_date = last_visit_date,
num_visits_before_frac = num_visits_before_frac,
num_visits_after_frac = num_visits_after_frac,
osteo_med_start_date = osteo_med_start_date,
osteo_med_start_dose = osteo_med_start_dose,
osteo_med_last_date = osteo_med_last_date
)
}
#end of loop
#Add the number of visits and date of the first visit prior to fractrue date
#Add a line of code to calculate the number of patients excluded at each step of the code
```
The tibble 'Fracture_Dates' now contains a row for each patient and associated information necessary to calculate FRAX score. Below we will use the 'FRAX' tibble create from publicly available FRAX paper charts (https://www.sheffield.ac.uk/FRAX/charts.aspx) to calculate the FRAX score for each patient.

Discern whether the patients with fracture have diabetes.
What is the duration of disease prior to fracture?
Were they well controlled?
```{r Diabetes calculator}
DM_dates_fx <- tibble (
  ID = numeric(),
  Dx_DATE = mdy_hms(),
  Duration = duration(),
  HBA1C_max = numeric(),
  HBA1C_max_date = character(),
  HBA1C_avg = numeric()
)

#Written because I imported Fracture date from an excel file
#Fracture_Date <- Fracture_Date %>% select(!(X))
#Fracture_Date$DATE <- as.Date.character(Fracture_Date$DATE)
#Fracture_Date$DATE <- as.POSIXct(Fracture_Date$DATE)

#Select patients with type 2 DM using ICD-10/9 code 'E11' or '250'
All_DM <- x %>% 
  filter((grepl('E11|250', CODE))) %>% 
  select(ID, DATE) %>% group_by(ID) %>% arrange(DATE, .by_group = TRUE) %>% distinct(ID, .keep_all = TRUE)
#Select patients with DM for whom we have a Frax score
Fracture_dates_final <- transform(na.omit(Fracture_Dates), ID = as.character(ID))
ID_DM <- inner_join(All_DM, Fracture_dates_final, by = 'ID')

#Remove patients diagnosed with DM after the first fracture
ID_DM <- ID_DM %>% mutate(
  days_before_fracture = DATE.y - DATE.x)
ID_DM <- ID_DM[ID_DM$days_before_fracture > 0,]
```
Diabetes loop
```{r DM loop}
for(i in 1:nrow(ID_DM)) {
  id <- as.double(ID_DM$ID[i])
  
  #Date of patients first fracture
  fracture_date <- ID_DM$DATE.y[i]

 #if (as.character(fracture_date) == 'NA') {next}
  pt_DM <- ID_DM$DATE.x[i]
  
days_before_fracture <- (fracture_date[[1]]) - pt_DM

#HBA1C's prior to fracture and date of measurement
HBA1C <- x %>% 
  filter(ID == id) %>%
  filter(grepl('HBA1C', CODE)) %>%
  filter(UNITS == '%') %>%
  filter(DATE <= fracture_date)

HBA1C_max <- as.double(max(HBA1C$NUMERIC_VALUE))
HBA1C_max <- ifelse(is.na(HBA1C_max),0,HBA1C_max)

HBA1C_max_date <- (HBA1C %>%
                     filter(NUMERIC_VALUE == HBA1C_max))$DATE[1]

#Average HBA1C in the year before fracture
HBA1C_avg <- HBA1C$NUMERIC_VALUE %>% as.double() %>% mean()
HBA1C_avg <- ifelse(is.na(HBA1C_avg),0,HBA1C_avg)

  DM_dates_fx <- DM_dates_fx %>% add_row(
   ID = id,
   Dx_DATE = pt_DM,
   Duration = days_before_fracture,
   HBA1C_max = as.double(HBA1C_max),
   HBA1C_max_date = as.character(HBA1C_max_date),
   HBA1C_avg = as.double(HBA1C_avg)
   #Add inslin to this loop
)
}
DM_dates_fx_HBA1C <- na.omit(DM_dates_fx)

write.csv(DM_dates_fx, "C:\\Users\\acriscit\\Documents\\DM_dates_fx.csv")
```
#Calculate FRAX score below
```{r FRAX calculator}
px <- Fracture_Dates

#Round BMI down to the nearest 5
floorfive <- function(x) {floor(x/5)*5}
px <- px %>% mutate(
  BMI = ifelse((BMI<45)&(BMI>15),floorfive(BMI), 
               ifelse (BMI>45,45,15)
               )
  )

#Round age down to the nearest 5
px <- px %>% mutate (
  AGE = ifelse((AGE<90)&(AGE>50),floorfive(AGE), 
               ifelse (AGE<50,50,90)
               )
  )

#Change race to white if not white, black, hispanic or asian
#Original race will be maintained the the column 'Og_RACE'
px$Og_RACE <- as.character(px$Og_RACE)
Races <- c("W","B","H","A")
px <- px %>% mutate(RACE = ifelse(
  (Og_RACE %in% Races), Og_RACE, "W")
  )

#Join FRAX and px to calculate 10 year risk of major osteoporotic fracture
fx <- px %>% 
  left_join(FRAX, by= c("GENDER","RACE","AGE","CRF","BMI"), copy=FALSE, keep=FALSE)%>%
  select(ID, Risk, Range_upper, Range_lower) %>% 
  arrange(ID)

percent_complete_cases <- (sum(complete.cases(fx))/nrow(fx))*100

#Remove incomplete cases
fxfinal <- na.omit(fx)

#write.csv(fxfinal, "C:\\Users\\acriscit\\Documents\\fxfinal.csv")
#write.csv(Fracture_Dates, "C:\\Users\\acriscit\\Documents\\Fracture_Date.csv")

```
Other questions to ask by modifying this script
  Current question: Does FRAX estimate fracture risk for DM and non-DM patients equally? and Do FRAX scores differ between those with and without diabetes?
Others:
  Does duration of diabetes alter fracture risk?
  Does FRAX score change leading up to a fracture?



