---
title: "FRAX calculator for I2b2 results"
output: html_document
---
library(tidyverse)
library(dplyr)
library(readxl)
library(lubridate)
#load FRAX paper charts (10-year risk of major osteoporotic fracture based on BMI)
FRAX <-  read.csv("C:\\Users\\acriscit\\Documents\\FRAX.csv", header = TRUE, stringsAsFactors = FALSE)
FRAX <- FRAX %>% data.frame()
names(FRAX)<- c("GENDER", "RACE", "AGE","CRF","BMI","Risk", "Range_upper", "Range_lower")

#Load I2b2 data
#xl_data <- "C:\\Users\\acriscit\\Documents\\20201020180719000_acriscit.xlsx"

#load sample patient data
xl_data <-  "C:\\Users\\acriscit\\Documents\\Sample FRAX patients.xlsx"

#Label data by excel tab
tab_names <- excel_sheets(path = xl_data)
pts <- lapply(tab_names, function(x) read_excel(path = xl_data, sheet = x))
pts <- pts %>% set_names(tab_names)

#Combine tabs that contain the same type of information
#Look at the excel sheet to see which data is stored across multiple tabs and double check that the code covers these
tab_names2 <- tibble(
Row = (1:length(tab_names)),
tab_names = tab_names
)
  #Meds
Med_tabs <- tab_names2 %>% filter((grepl('Meds', tab_names)))
pts$Meds <- bind_rows(pts[Med_tabs$Row])
  #Labs
Lab_tabs <- tab_names2 %>% filter((grepl('Labs', tab_names)))
pts$Labs <- bind_rows(pts[Lab_tabs$Row])
  #Vitals
Vital_tabs <- tab_names2 %>% filter((grepl('Vitals', tab_names)))
pts$Vitals <- bind_rows(pts[Vital_tabs$Row])

#rename columns so that all tabs can be combined in a tidy fashion and to remove spaces from column names
names(pts$Diagnoses)<- c("ID", "VISIT#","DATE", "CODE", "DESC", "MODIFIER")
names(pts$Meds)<-c("ID",    "VISIT#", "DATE","CODE", "DESC", "MODIFIER", "TEXT_VALUE", "NUMERIC_VALUE", "UNITS")
names(pts$Smoking)<-c("ID",    "VISIT#", "DATE","CODE", "DESC", "TEXT_VALUE")
names(pts$Vitals)<-c("ID","VISIT#","DATE","CODE", "DESC", "TEXT_VALUE", "NUMERIC_VALUE", "UNITS")
names(pts$Patients)<-c("ID", "AGE_NOW", "AGE_AT_DEATH", "GENDER", "RACE", "MIXED RACE", "ETHNICITY")

#Tidy the data: Create one tibble from the list 'pts', Exclude the 'Patients' and 'Cover' tabs
x <- bind_rows(pts[3:6])
#Create another tibble with patient demographics from the 'Patients' tab
y <- bind_rows(pts[2])

#Convert dates to date form
x$DATE <- mdy_hms(x$DATE)

#Create a tibble ('Fracture_Dates') with the date of the most recent fracture for each patiet and associated FRAX characteristics
Fracture_Dates <- x %>% filter(CODE == "M80" | DESC == "fracture") %>% select(ID,'VISIT#',DATE,CODE,DESC,MODIFIER) %>% mutate(
HT.in = 1, 
HTDaysBeforeFrac = 1, 
WT.in = 1, 
WtDaysBeforeFrac = 1, 
FractureAge = 1, 
GENDER = 1, 
RACE = 1, 
CRF = 1,
BMI = 1)
#CRF is Combined Risk Factors

#Create a loop to identify each fracture event in 'x', such that all info pertinent to FRAX can be drawn for that fracture event
#HTWT <- HTWT %>% mutate(ID = gsub(" ", "",HTWT$ID))
for(i in 1:length(Fracture_Dates$ID)){
id <- as.character(select(Fracture_Dates, ID)[i,1])
date <- select(Fracture_Dates, DATE)[i,1]
#Select height and weight nearest time of fracture
HT <- filter(x,CODE == "HT", ID == id, DATE <= date) %>% arrange(desc(DATE))
WT <- filter(x,CODE == "WT", ID == id, DATE <= date) %>% arrange(desc(DATE))
#Add height to Fracture_Dates
Fracture_Dates$HT.in[i] <- HT[1,] %>% select(NUMERIC_VALUE) %>% as.double()
#Days8 is the days between the fracture and height measurement
#In lubridate, days are calculated from 1970-01-01
Fracture_Dates$HTDaysBeforeFrac[i] <- as.double(date - HT[1,3])
#Add weight to Fracture_Dates
Fracture_Dates$WT.in[i] <- WT[1,] %>% select(NUMERIC_VALUE) %>% as.double()
#The days between the fracture and weight measurement
Fracture_Dates$WTDaysBeforeFrac[i] <- as.double(date - WT[1,3])
#Calculate BMI from HT and WT
Fracture_Dates$BMI[i] <- (703*as.double(WT[1,8])/as.double(HT[1,8])^2)
#Calcuate age at time of fracture
b <- y %>% filter(ID == id) %>% select(AGE_NOW)
ageatfracture = as.double(b) - (as.double(year(today())) - as.double(year(Fracture_Dates$DATE[i])))
Fracture_Dates$DATE[i] <- ageatfracture

#Select gender
Fracture_Dates$GENDER[i] <- y %>% filter(ID == id) %>% select(GENDER)

#Select race
Fracture_Dates$RACE[i] <- y %>% filter(ID == id) %>% select(RACE)

#Combined Risk Factors (CRFs)
#Tibble where CRFs will be compiled
CRF <- tibble(
Fracture = character(),
Smoker = character(),
EToH = character(),
RA = character(),
Osteoporosis = character(),
Parent_Osteoporosis = character(),
Glucocorticoid = character()
)

#Select CRFs (Fracture	Parent fracture	Smoking	Glucocorticoids	RA	Alcohol use	Secodary osteoporosis)
e <- x %>% filter(ID == id, DATE < date)

Fracture1 <- as.character((e %>% filter(grepl('Fracture|fracture', DESC)) %>% select(DESC))[1,1])

Smoker1 <- as.character((e %>% filter(grepl('Smoker|smoker', DESC)) %>% select(DESC))[1,1])

EToH1 <- as.character((e %>% filter(grepl('Alcoholism|alcoholism', DESC)) %>% select(DESC))[1,1])

RA1 <- as.character((e %>% filter(grepl('Rheumatoid|rheumatoid', DESC),grepl('M05|M06|714', CODE)) %>% select(DESC))[1,1])

Osteoporosis1 <- as.character((e %>% filter(grepl('Osteoporosis|osteoporosis', DESC), grepl('M80|733', CODE)) %>% select(DESC))[1,1])

Parent_Osteoporosis1 <- as.character((e %>% filter(grepl('Z82.62|V17.81', CODE)) %>% select(CODE))[1,1])

Glucocorticoid1 <- as.character((e %>% filter(DATE < date, grepl('sone|solone', DESC)) %>% select(DESC))[1,1])
#Work on glucs filter criteria and find out whether they need to be taking it at the time of fracture for it to count

CRF <- CRF %>% add_row(
Fracture = Fracture1,
Smoker = Smoker1,
EToH = EToH1,
RA = RA1,
Osteoporosis = Osteoporosis1,
Parent_Osteoporosis = Parent_Osteoporosis1,
Glucocorticoid = Glucocorticoid1
)
#Convert risk factors to 0 (not present) or 1 (present)
CRF[is.na(CRF)] <- '0'
for(j in 1:ncol(CRF)){
CRF[1,j] <- ifelse(CRF[1,j] == "0","0","1")
}
#Calculate CRF score and add it to Fracture_Dates
CRF_score <- sum(as.double(CRF))
Fracture_Dates$CRF[i] <- CRF_score
}
#end of loop
#For some reason using filter with dates creates an error, however, these functions appear to work as expected
px <- Fracture_Dates

#Do they have DMII at the time of fracture? How long before?

#Calculate FRAX score below

#Round BMI down to the nearest 5
floorfive <- function(x) {floor(x/5)*5}
px <- px %>% mutate(rBMI = ifelse((BMI<45)&(BMI>15),floorfive(BMI), ifelse (BMI>45,45,15)))
#Round age down to the nearest 5
px <- px %>% mutate (rAge = ifelse((FractureAge<90)&(FractureAge>50),floorfive(FractureAge), ifelse (FractureAge<50,50,90)))
#Change race to caucasian if not caucasian, black, hispanic or asian
px$RACE <- as.character(px$RACE)
Races <- c("W","B","H","A")
px <- px %>% mutate(RACE = ifelse((RACE %in% Races), RACE, "W"))
#Rename colum FractureAge to AGE
px <- px %>% rename(AGE = FractureAge)

#Join FRAX and px to calculate 10 year risk of major osteporotic fracture
fx <- FRAX %>% semi_join(px, by= c("GENDER","RACE","AGE","CRF","BMI")) %>% left_join(px, by = c("GENDER","RACE","AGE","CRF","BMI")) %>% select(ID, Risk, Range_upper, Range_lower)  %>% arrange(ID)

write.csv(fx, "C:\\Users\\acriscit\\Documents\\fx.csv")