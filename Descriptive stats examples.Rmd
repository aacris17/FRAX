---
title: "Code for descriptive characteristics"
author: "Anthony Criscitiello"
date: "3/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r descriptive}
Fracture_Date <- read.csv( "C:\\Users\\acriscit\\Documents\\Fracture_Date.csv")
```
86.3% had data needed for FRAX score
86.4% had height data
88.8% had weight data
13.7% were missing data needed for FRAX score

```{r desc}

fx <- fx[-1]
Fracture_Dates <- Fracture_Date[-1]
Fracture_Dates$DATE <- ymd_hms(Fracture_Dates$DATE)
Fracture_Dates_fx <- left_join(Fracture_Dates, fx, by = 'ID')

Desc <- summary(Fracture_Dates_fx_no_DM)
names(dimnames(Desc)) <- c("x", "y")
Desc <- as.tibble(Desc)
# mean,median,25th and 75th quartiles,min,max

#tidy it up with 'separate' and 'pivot_wider'
Desc <- Desc[-1]

Desc <- separate(
  Desc, 
  "n",
  c("m", "n"),
  sep = ":",
  remove = TRUE,
  convert = TRUE
  )

Desc <- Desc %>%
  na.omit() %>%
  pivot_wider(
    names_from = m, 
    values_from = n
              )

write.csv(Desc, "C:\\Users\\acriscit\\Documents\\Descriptors_no_DM.csv")

Desc <- summary(DM_Dates_fx)
names(dimnames(Desc)) <- c("x", "y")
Desc <- as.tibble(Desc)
# mean,median,25th and 75th quartiles,min,max

#tidy it up with 'separate' and 'pivot_wider'
Desc <- Desc[-1]

Desc <- separate(
  Desc, 
  "n",
  c("m", "n"),
  sep = ":",
  remove = TRUE,
  convert = TRUE
  )

Desc <- Desc %>%
  na.omit() %>%
  pivot_wider(
    names_from = m, 
    values_from = n
              )

write.csv(Desc, "C:\\Users\\acriscit\\Documents\\Descriptors_DM.csv")

#Type of fracture
Hip_fracture <- Fracture_Dates %>% filter(grepl("[Ff]emur", DESC))
Hip <- Hip_fracture %>% count() %>% as.double()
perc_hip <- (Hip/nrow(Fracture_Dates))*100 %>% as.double()
Major_fracture <- Fracture_Dates %>% filter(grepl("[Ss]pine", DESC)| grepl("[Ww]rist", DESC)| grepl("[Hh]umerus", DESC))
Major <- Major_fracture %>% count() %>% as.double()
perc_major <- (Major/nrow(Fracture_Dates))*100 %>% as.double()

#Gender
Men <- Fracture_Dates_fx_no_DM %>% filter(GENDER == 'M') %>% select(GENDER) %>% count() %>% as.double()
Percent_Men <- (Men / nrow(Fracture_Dates_fx_no_DM))*100

Men_DM <- DM_Dates_fx %>% filter(GENDER == 'M') %>% select(GENDER) %>% count() %>% as.double()
Percent_Men_DM <- (Men_DM / nrow(DM_Dates_fx))*100

#Race
percent_White <- (
  (
    Fracture_Dates_fx_no_DM %>%
  filter(Og_RACE == 'W') %>%
  nrow()
  )/nrow(Fracture_Dates_fx_no_DM)
  )*100

White <- Fracture_Dates_fx_no_DM
White$Og_RACE[White$Og_RACE == 'W'] <- '1'
White$Og_RACE[is.na(White$Og_RACE)] <- '0'
White$Og_RACE <- as.numeric(White$Og_RACE)

White_DM <- DM_Dates_fx
White_DM$Og_RACE[White_DM$Og_RACE == 'W'] <- '1'
White_DM$Og_RACE[is.na(White_DM$Og_RACE)] <- '0'
White_DM$Og_RACE <- as.numeric(White_DM$Og_RACE)

t.test(percent_White, percent_White_DM,
       alternative = c("two.sided"),
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)
rm(White_DM)
rm(White)

percent_White_DM <- (
  (
    DM_Dates_fx %>%
  filter(Og_RACE == 'W') %>%
  nrow()
  )/nrow(DM_Dates_fx)
  )*100

percent_Black <- (
  (
    Fracture_Dates_fx_no_DM %>%
  filter(Og_RACE == 'B') %>%
  nrow()
  )/nrow(Fracture_Dates_fx_no_DM)
  )*100

percent_Black_DM <- (
  (
    DM_Dates_fx %>%
  filter(Og_RACE == 'B') %>%
  nrow()
  )/nrow(DM_Dates_fx)
  )*100



#Number with FRAX score that warranted treatment
fx_to_treat <- Fracture_Dates_fx_no_DM %>% filter(Risk >= 20)

fx_to_treat_DM <- DM_Dates_fx %>% filter(Risk >= 20)

fx_to_treat_lower <- (Fracture_Dates_fx_no_DM %>% filter(Range_lower >= 20) %>% count())/1544

fx_to_treat_lower_DM <- (DM_Dates_fx %>% filter(Range_upper >= 20) %>% count())/500

#Osteoporosis meds
Osteo_meds <- Fracture_Dates_fx_no_DM %>%
  filter(!(osteo_med_name == 'NA'))
nrow(Osteo_meds)/1544
RX_to_treat <- inner_join(Osteo_meds, fx_to_treat, by = 'ID')
nrow(RX_to_treat)/nrow(fx_to_treat)

Osteo_meds_DM <- DM_Dates_fx %>%
  filter(!(osteo_med_name == 'NA'))
nrow(Osteo_meds)/500
RX_to_treat_DM <- inner_join(Osteo_meds_DM, fx_to_treat_DM, by = 'ID')
nrow(RX_to_treat_DM)/nrow(fx_to_treat_DM)

#Diabetes
#Question 1. Is FRAX score different between those with and without DM?
DM_Dates_fx <- DM_dates_fx[-1]
colnames <- DM_Dates_fx[1,]
names(DM_Dates_fx) <- colnames
DM_Dates_fx <- DM_Dates_fx[-1,] %>% as.tibble
DM_Dates_fx$ID <- as.numeric(DM_Dates_fx$ID)
rm(colnames)
#Patients with Fracture and DM w/ FRAX scores
DM_Dates_fx <- left_join(DM_Dates_fx, Fracture_Dates_fx, by = 'ID')

#Patients with Fracture, w/o DM, w/ FRAX scores
Fracture_Dates_fx_no_DM <- anti_join(Fracture_Dates_fx, DM_Dates_fx, by = 'ID')

fx_risk_nonDM_vs_DM <- t.test(DM_Dates_fx$Risk, Fracture_Dates_fx_no_DM$Risk, 
       alternative = c("two.sided"), #Less indicates that the alternative hypothesis is that those with DM have lower FRAX score (x-y)
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)

#Question 2. Is age of fracture different between those with and without DM?
fx_age_nonDM_vs_DM <- t.test(DM_Dates_fx$AGE, Fracture_Dates_fx_no_DM$AGE,  
       alternative = c("two.sided"), #Less indicates that the alternative hypothesis is that those with DM fracture younger
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)

#Question 3. Is BMI significantly different between DM and non-DM?
fx_BMI_nonDM_vs_DM <- t.test(DM_Dates_fx$BMI, Fracture_Dates_fx_no_DM$BMI,  
       alternative = c("two.sided"), #Greater indicates that the alternative hypothesis is that those with DM have a higher BMI
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)

#Question: What are the risk of being black and having DM
percent_B_DM <- ((nrow(DM_Dates_fx %>% 
                        filter(Og_RACE == "B")))/(nrow(DM_Dates_fx)))

percent_B <- (nrow(Fracture_Dates_fx_no_DM %>% 
           filter(Og_RACE == "B"))
/(nrow(Fracture_Dates_fx_no_DM)))

RR_B <- percent_B_DM/percent_B

#Question: Are those taking meds more likely to be white?

#Question: Are those without DM more likely to be taking anti-osteoporotic meds

```
Plotting linear regression

DXA
tibble_names$Procedures %>% filter(grepl('DXA', DESC)) %>% select(DATE, ID)
``` {r linear regression}
fx_Fracture_Dates <- Fracture_Dates_fx

#Age vs FRAX Risk score
lm_FRAX_AGE <- lm(Risk ~ AGE, data = fx_Fracture_Dates)
summary(lm_FRAX_AGE)

ggplot(fx_Fracture_Dates, aes(x=AGE, y=Risk)) +
  geom_point(size = 0.25)+
  geom_smooth(method="lm", color = "#9D7C2F") +
  xlab("Age (years)") +
  ylab("FRAX score") +
  theme_bw() +
  ggtitle("Age vs FRAX score")

#DM linear regression
fxfinal <- transform(na.omit(fx), ID = as.character(ID))

ID_DM_HBA1C <- DM_Dates_fx %>% filter(HBA1C_avg > 0)

lm_ABA1Cavg_Age <- lm(Risk ~ HBA1C_avg, data = ID_DM_HBA1C)
summary(lm_ABA1Cavg_Age)

ggplot(lm_ABA1Cavg_Age, aes(x=HBA1C_avg, y=Risk)) +
  geom_point(size = 0.25)+
  geom_smooth(method="lm", color = "#9D7C2F") +
  xlab("HbA1C mean (%)") +
  ylab("FRAX score") +
  theme_bw() +
  ggtitle("HbA1C vs FRAX score")


lm_ABA1Cavg_max <- lm(Risk ~ HBA1C_max, data = ID_DM_HBA1C)
summary(lm_ABA1Cavg_max)

ggplot(lm_ABA1Cavg_max, aes(x=HBA1C_max, y=Risk)) +
  geom_point(size = 0.25)+
  geom_smooth(method="lm", color = "#9D7C2F") +
  xlab("HbA1C max (%)") +
  ylab("FRAX score") +
  theme_bw() +
  ggtitle("HbA1C vs FRAX score")


lm_ABA1Cavg_time <- lm(Risk ~ Duration, data = DM_Dates_fx)
summary(lm_ABA1Cavg_time)

ggplot(lm_ABA1Cavg_time, aes(x=Duration, y=Risk)) +
  geom_point(size = 0.25)+
  geom_smooth(method="lm", color = "#9D7C2F") +
  xlab("Time (seconds)") +
  ylab("FRAX score") +
  theme_bw() +
  ggtitle("DM duration vs FRAX score")

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
